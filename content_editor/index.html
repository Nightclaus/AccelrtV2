<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Updater</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f6f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 850px; /* Wider for more fields */
            margin-bottom: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        textarea, input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 14px;
            margin-bottom: 15px;
            color: #495057;
        }
        textarea#jsonData {
            min-height: 250px;
        }
        textarea.dynamic-field {
            min-height: 80px; /* Smaller for individual field textareas */
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #80bdff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status-message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .api-key-group {
            margin-bottom: 20px;
        }
        .separator {
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            margin: 40px 0;
            color: #6c757d;
        }
        .dynamic-form-section {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f8f9fa;
        }
        .dynamic-form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #007bff;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            font-size: 1.3em;
        }
        .dynamic-form-section h4 { /* For array item titles */
            margin-top: 15px;
            margin-bottom: 10px;
            color: #343a40;
            font-size: 1.1em;
            border-top: 1px dashed #ced4da;
            padding-top: 10px;
        }
        .form-field {
            margin-bottom: 15px;
        }
        .form-field small {
            display: block;
            color: #6c757d;
            font-size: 0.85em;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Update Website Content (Raw JSON)</h1>

        <div class="api-key-group">
            <label for="apiKey">API Key:</label>
            <input type="password" id="apiKey" placeholder="Enter your Access Key">
        </div>

        <div class="form-group">
            <label for="jsonData">Paste Full JSON Content Here:</label>
            <textarea id="jsonData" placeholder='{ "hero": { "title": "New Title" }, ... }'></textarea>
        </div>

        <button id="submitRawJsonBtn">Update with Raw JSON</button>
        <div id="statusMessageRaw" class="status-message" style="display: none;"></div>
    </div>

    <div class="separator">--- OR ---</div>

    <div class="container">
        <h2>Update Content via Form</h2>
        <button id="loadCurrentDataBtn">Load Current Data & Build Form</button>
        <div id="dynamicFormContainer" style="margin-top: 20px;">
            <!-- Dynamic form fields will be injected here -->
        </div>
        <button id="submitFormDataBtn" style="display:none; margin-top: 20px;">Update with Form Data</button>
        <div id="statusMessageForm" class="status-message" style="display: none;"></div>
    </div>

    <script>
        const jsonDataTextarea = document.getElementById('jsonData');
        const submitRawJsonBtn = document.getElementById('submitRawJsonBtn');
        const statusMessageRawDiv = document.getElementById('statusMessageRaw');
        
        const apiKeyInput = document.getElementById('apiKey');
        const loadCurrentDataBtn = document.getElementById('loadCurrentDataBtn');
        const dynamicFormContainer = document.getElementById('dynamicFormContainer');
        const submitFormDataBtn = document.getElementById('submitFormDataBtn');
        const statusMessageFormDiv = document.getElementById('statusMessageForm');

        // --- CONFIGURATION ---
        // REPLACE these with your actual Vercel API endpoint URLs
        const UPDATE_API_URL = 'https://accelrt-v2.vercel.app/api/update-data'; 
        const GET_API_URL = 'https://accelrt-v2.vercel.app/api/get-data';    
        // For local testing with `vercel dev` (if this HTML is also served by it):
        // const UPDATE_API_URL = '/api/update-data'; 
        // const GET_API_URL = '/api/get-data';
        // --- END CONFIGURATION ---

        let currentFetchedData = null; // To store the fetched data for recompilation

        // --- RAW JSON SUBMISSION ---
        submitRawJsonBtn.addEventListener('click', async function() {
            await submitData(jsonDataTextarea.value.trim(), statusMessageRawDiv, submitRawJsonBtn);
        });

        // --- DYNAMIC FORM SECTION ---
        loadCurrentDataBtn.addEventListener('click', async function() {
            console.log("Attempting to load current data...");
            loadCurrentDataBtn.disabled = true;
            loadCurrentDataBtn.textContent = 'Loading...';
            dynamicFormContainer.innerHTML = '<p>Fetching current data...</p>';
            submitFormDataBtn.style.display = 'none';
            displayStatusGeneral('', null, statusMessageFormDiv);

            const apiKey = apiKeyInput.value.trim();
            const headers = {};
            if (apiKey) {
                headers['X-API-KEY'] = apiKey; 
            }

            try {
                const response = await fetch(GET_API_URL, { headers });
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ error: "Failed to parse error response as JSON." }));
                    throw new Error(errorResult.error || `Failed to load current data. Status: ${response.status}`);
                }
                currentFetchedData = await response.json();
                console.log("Fetched data for form builder:", currentFetchedData);

                if (currentFetchedData && typeof currentFetchedData === 'object') {
                    buildDynamicForm(currentFetchedData);
                    submitFormDataBtn.style.display = 'block';
                    const fetchingMsg = dynamicFormContainer.querySelector('p');
                    if (fetchingMsg && fetchingMsg.textContent.startsWith('Fetching')) fetchingMsg.remove();
                } else {
                    throw new Error("Fetched data is not a valid object.");
                }

            } catch (error) {
                console.error('Error loading current data:', error);
                displayStatusGeneral(`Error loading data: ${error.message}`, 'error', statusMessageFormDiv);
                dynamicFormContainer.innerHTML = `<p style="color:red;">Failed to load data for form. Check console.</p>`;
            } finally {
                loadCurrentDataBtn.disabled = false;
                loadCurrentDataBtn.textContent = 'Load Current Data & Build Form';
            }
        });

        function createFieldElement(id, value, originalType) {
            let element;
            if (originalType === 'string' && String(value).length > 70) { // Use textarea for longer strings
                element = document.createElement('textarea');
                element.className = 'dynamic-field';
                element.rows = Math.max(3, Math.ceil(String(value).length / 60));
            } else if (originalType === 'number') {
                element = document.createElement('input');
                element.type = 'number';
                element.step = 'any'; // Allow decimals
            } else if (originalType === 'boolean') {
                element = document.createElement('select');
                const optionTrue = document.createElement('option');
                optionTrue.value = 'true';
                optionTrue.textContent = 'True';
                const optionFalse = document.createElement('option');
                optionFalse.value = 'false';
                optionFalse.textContent = 'False';
                element.appendChild(optionTrue);
                element.appendChild(optionFalse);
            }
            else { // Default to text input for strings or other types
                element = document.createElement('input');
                element.type = 'text';
            }
            element.id = id;
            element.name = id;
            element.value = value; // For select, this sets the selected option if value matches
            return element;
        }
        
        function buildFormField(key, value, prefix, parentDiv) {
            const fieldId = prefix ? `${prefix}-${key}` : key;
            const originalType = typeof value;

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'form-field';

            const label = document.createElement('label');
            label.htmlFor = fieldId;
            label.textContent = capitalizeFirstLetter(String(key).replace(/([A-Z])/g, ' $1')) + ':';
            fieldDiv.appendChild(label);

            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                // Recursively build for nested objects (1 more level)
                const nestedSectionDiv = document.createElement('div');
                nestedSectionDiv.style.paddingLeft = '20px';
                nestedSectionDiv.style.borderLeft = '2px solid #eee';
                for(const nestedKey in value) {
                    if (Object.hasOwnProperty.call(value, nestedKey)) {
                        buildFormField(nestedKey, value[nestedKey], fieldId, nestedSectionDiv);
                    }
                }
                fieldDiv.appendChild(nestedSectionDiv);

            } else if (Array.isArray(value)) {
                 // For arrays, just show raw JSON in a disabled textarea
                const textarea = document.createElement('textarea');
                textarea.id = fieldId;
                textarea.name = fieldId;
                textarea.value = JSON.stringify(value, null, 2);
                textarea.className = 'dynamic-field';
                textarea.rows = Math.min(10, value.length + 1); // Adjust rows based on array length
                textarea.disabled = true;
                const notice = document.createElement('small');
                notice.textContent = '(Array data - edit via Raw JSON editor or ensure JSON structure for array items)';
                fieldDiv.appendChild(textarea);
                fieldDiv.appendChild(notice);

            } else { // Simple type: string, number, boolean
                const inputElement = createFieldElement(fieldId, value, originalType);
                fieldDiv.appendChild(inputElement);
            }
            parentDiv.appendChild(fieldDiv);
        }


        function buildDynamicForm(data) {
            dynamicFormContainer.innerHTML = ''; 
            console.log("Building form, clearing container.");

            for (const sectionKey in data) {
                if (Object.hasOwnProperty.call(data, sectionKey)) {
                    console.log("Processing sectionKey for form:", sectionKey);
                    const sectionValue = data[sectionKey];
                    
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'dynamic-form-section';
                    sectionDiv.setAttribute('data-section-key', sectionKey); // Store original key
                    
                    const sectionTitle = document.createElement('h3');
                    sectionTitle.textContent = capitalizeFirstLetter(sectionKey.replace(/([A-Z])/g, ' $1'));
                    sectionDiv.appendChild(sectionTitle);

                    if (typeof sectionValue === 'object' && sectionValue !== null && !Array.isArray(sectionValue)) {
                        // Second layer - object of fields
                        for (const fieldKey in sectionValue) {
                            if (Object.hasOwnProperty.call(sectionValue, fieldKey)) {
                                buildFormField(fieldKey, sectionValue[fieldKey], sectionKey, sectionDiv);
                            }
                        }
                    } else if (Array.isArray(sectionValue)) {
                        // Handle top-level arrays (e.g., services, teamMembers, faqItems)
                        // This part will render fields for each object in the array
                        sectionValue.forEach((item, index) => {
                            if (typeof item === 'object' && item !== null) {
                                const itemTitle = document.createElement('h4');
                                itemTitle.textContent = `${capitalizeFirstLetter(sectionKey.slice(0,-1) || 'Item')} ${index + 1}`; // e.g. Service 1
                                sectionDiv.appendChild(itemTitle);
                                
                                const itemPrefix = `${sectionKey}-${index}`;
                                for (const itemKey in item) {
                                    if (Object.hasOwnProperty.call(item, itemKey)) {
                                        buildFormField(itemKey, item[itemKey], itemPrefix, sectionDiv);
                                    }
                                }
                            } else {
                                // Array of simple values - show as one disabled field
                                buildFormField(`item-${index}`, item, sectionKey, sectionDiv);
                                const inputEl = sectionDiv.querySelector(`#${sectionKey}-item-${index}`);
                                if (inputEl) inputEl.disabled = true;
                                const notice = document.createElement('small'); notice.textContent = '(Simple array item - edit via Raw JSON)';
                                sectionDiv.querySelector('.form-field:last-child').appendChild(notice);

                            }
                        });
                    } else {
                        // Top-level simple value (string, number, boolean)
                        buildFormField(sectionKey, sectionValue, '', sectionDiv); // No prefix for top-level simple field
                    }
                    dynamicFormContainer.appendChild(sectionDiv);
                    console.log("Appended section to form:", sectionKey);
                }
            }
            console.log("Finished building dynamic form HTML structure.");
        }


        function recompileFormData() {
            if (!currentFetchedData) return null;
            
            // Start with a deep clone of the original structure to preserve types and uneditable parts
            const updatedData = JSON.parse(JSON.stringify(currentFetchedData)); 

            console.log("Recompiling form data. Original structure:", JSON.stringify(updatedData).substring(0,200));

            const sections = dynamicFormContainer.querySelectorAll('.dynamic-form-section');
            sections.forEach(sectionDiv => {
                const sectionKey = sectionDiv.getAttribute('data-section-key');
                if (!sectionKey || !Object.hasOwnProperty.call(updatedData, sectionKey)) {
                    console.warn("Could not find original section key for form section:", sectionDiv);
                    return;
                }
                
                console.log("Recompiling section:", sectionKey);

                if (Array.isArray(updatedData[sectionKey])) {
                    // Recompile array of objects
                    updatedData[sectionKey].forEach((item, itemIndex) => {
                        if (typeof item === 'object' && item !== null) {
                            for (const itemKey in item) {
                                if (Object.hasOwnProperty.call(item, itemKey)) {
                                    const fieldId = `${sectionKey}-${itemIndex}-${itemKey}`;
                                    const inputElement = document.getElementById(fieldId);
                                    if (inputElement && !inputElement.disabled) {
                                        const originalItemValue = item[itemKey];
                                        if (typeof originalItemValue === 'number') {
                                            item[itemKey] = parseFloat(inputElement.value) || 0;
                                        } else if (typeof originalItemValue === 'boolean') {
                                            item[itemKey] = inputElement.value === 'true';
                                        } else {
                                            item[itemKey] = inputElement.value;
                                        }
                                    }
                                }
                            }
                        }
                        // Simple arrays are not made editable by this form builder
                    });
                } else if (typeof updatedData[sectionKey] === 'object' && updatedData[sectionKey] !== null) {
                    // Recompile object of fields (second layer)
                    for (const fieldKey in updatedData[sectionKey]) {
                        if (Object.hasOwnProperty.call(updatedData[sectionKey], fieldKey)) {
                            const fieldId = `${sectionKey}-${fieldKey}`;
                            const inputElement = document.getElementById(fieldId);
                            if (inputElement && !inputElement.disabled) {
                                const originalFieldValue = updatedData[sectionKey][fieldKey];
                                if (typeof originalFieldValue === 'number') {
                                    updatedData[sectionKey][fieldKey] = parseFloat(inputElement.value) || 0;
                                } else if (typeof originalFieldValue === 'boolean') {
                                    updatedData[sectionKey][fieldKey] = inputElement.value === 'true';
                                } else {
                                    updatedData[sectionKey][fieldKey] = inputElement.value;
                                }
                            } else if (inputElement && inputElement.disabled){
                                // If it was disabled (e.g. complex nested object), keep original value
                                // This happens because updatedData is a clone of currentFetchedData
                            }
                        }
                    }
                } else {
                    // Recompile top-level simple value
                    const fieldId = sectionKey; // No prefix
                    const inputElement = document.getElementById(fieldId);
                    if (inputElement && !inputElement.disabled) {
                        const originalValue = updatedData[sectionKey];
                        if (typeof originalValue === 'number') {
                            updatedData[sectionKey] = parseFloat(inputElement.value) || 0;
                        } else if (typeof originalValue === 'boolean') {
                            updatedData[sectionKey] = inputElement.value === 'true';
                        } else {
                            updatedData[sectionKey] = inputElement.value;
                        }
                    }
                }
            });
            return updatedData;
        }


        submitFormDataBtn.addEventListener('click', async function() {
            const recompiledData = recompileFormData();
            if (recompiledData) {
                console.log("Data recompiled from form to be submitted:", recompiledData);
                await submitData(recompiledData, statusMessageFormDiv, submitFormDataBtn);
            } else {
                displayStatusGeneral('Could not recompile form data. Was data loaded?', 'error', statusMessageFormDiv);
            }
        });

        // --- SHARED SUBMISSION LOGIC ---
        async function submitData(dataToSubmitValue, statusDiv, submitButtonElement) {
            const apiKey = apiKeyInput.value.trim();
            let dataToSubmitObject;

            if (typeof dataToSubmitValue === 'string') { // For raw JSON textarea
                try {
                    dataToSubmitObject = JSON.parse(dataToSubmitValue);
                } catch (error) {
                    displayStatusGeneral(`Invalid JSON format: ${error.message}`, 'error', statusDiv);
                    return;
                }
            } else { // For already processed object from dynamic form
                dataToSubmitObject = dataToSubmitValue;
            }
            

            if (typeof dataToSubmitObject !== 'object' || dataToSubmitObject === null) {
                displayStatusGeneral('Data to submit must be a valid JSON object.', 'error', statusDiv);
                return;
            }

            submitButtonElement.disabled = true;
            displayStatusGeneral('Updating content...', null, statusDiv);

            const headers = { 'Content-Type': 'application/json' };
            if (apiKey) { headers['X-API-KEY'] = apiKey; }

            try {
                const response = await fetch(UPDATE_API_URL, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(dataToSubmitObject) 
                });
                const result = await response.json().catch(() => ({ message: "Update sent, but response was not valid JSON."})); // Catch if response isn't JSON

                if (!response.ok) {
                    throw new Error(result.error || result.message || `HTTP error! Status: ${response.status}`);
                }
                displayStatusGeneral(result.message || 'Content updated successfully!', 'success', statusDiv);
            } catch (error) {
                console.error('Error updating content:', error);
                displayStatusGeneral(`Failed to update: ${error.message}`, 'error', statusDiv);
            } finally {
                submitButtonElement.disabled = false;
            }
        }
        
        function displayStatusGeneral(message, type, statusDiv) {
            statusDiv.textContent = message;
            statusDiv.className = 'status-message';
            if (type) { statusDiv.classList.add(type); }
            statusDiv.style.display = 'block';
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

    </script>
</body>
</html>